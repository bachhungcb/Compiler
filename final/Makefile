# ƒê·ªãnh nghƒ©a c√°c th∆∞ m·ª•c con (Sub-directories)
# ƒê√¢y l√† c√°c module th√†nh ph·∫ßn trong ki·∫øn tr√∫c c·ªßa b·∫°n
COMPILER_DIR = completed
INTERPRETER_DIR = interpreter

# .PHONY ƒë√°nh d·∫•u c√°c target n√†y l√† gi·∫£ (kh√¥ng ph·∫£i t√™n file)
# ƒêi·ªÅu n√†y tr√°nh xung ƒë·ªôt n·∫øu v√¥ t√¨nh c√≥ file tr√πng t√™n v·ªõi th∆∞ m·ª•c
.PHONY: all clean $(COMPILER_DIR) $(INTERPRETER_DIR)

# Rule m·∫∑c ƒë·ªãnh: Build c·∫£ Compiler v√† Interpreter
all: $(COMPILER_DIR) $(INTERPRETER_DIR)
	@echo "Build process completed successfully for both binaries."

# Rule ƒë·ªÉ build Compiler (KPLC)
# C·ªù -C ch·ªâ th·ªã cho make thay ƒë·ªïi context v√†o th∆∞ m·ª•c con tr∆∞·ªõc khi th·ª±c thi
$(COMPILER_DIR):
	@echo "=== Building Compiler (KPLC) ==="
	$(MAKE) -C $(COMPILER_DIR)

# Rule ƒë·ªÉ build Interpreter (KPLRUN)
$(INTERPRETER_DIR):
	@echo "=== Building Interpreter (VM) ==="
	$(MAKE) -C $(INTERPRETER_DIR)

BIN_FILE = $(FILE:.kpl=.bin)

run: $(COMPILER_DIR) $(INTERPRETER_DIR)
	@if [ -z "$(FILE)" ]; then \
		echo "‚ùå [ERROR] Missing input file. Usage: make run FILE=path/to/code.kpl"; \
		exit 1; \
	fi
	@echo "üõ°Ô∏è [SEC] Starting Compilation Phase..."
	@# Ch·∫°y Compiler: ƒê·∫ßu v√†o l√† $(FILE), ƒë·∫ßu ra t·ª± ƒë·ªông l√† $(BIN_FILE)
	./$(COMPILER_DIR)/kplc $(FILE) $(BIN_FILE) -dump
	
	@echo "üöÄ [EXEC] Starting Execution Phase..."
	@# Ch·∫°y Interpreter v·ªõi file binary v·ª´a t·∫°o
	./$(INTERPRETER_DIR)/kplrun $(BIN_FILE)
	
	@echo "üßπ [CLEANUP] Removing artifact..."
	rm -f $(BIN_FILE)

# Rule ƒë·ªÉ d·ªçn d·∫πp (Clean) c√°c file object v√† binary ·ªü c·∫£ 2 th∆∞ m·ª•c
clean:
	@echo "=== Cleaning up build artifacts ==="
	$(MAKE) -C $(COMPILER_DIR) clean
	$(MAKE) -C $(INTERPRETER_DIR) clean